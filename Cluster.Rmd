```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = F)
```

```{r load.packages, include = FALSE}
library(papaja)
library(tidyverse)

rm(list = ls())

load("Data/Population Data/Cleaned Data.rdata")

# df.sim <- df.sim[1:100,]
# covariates <- covariates[1â€¢:3]
```

## SUBS


```{r SUBS_Funcs}
library(parallel)
library(fpc)
library(cluster)
library(tidyverse)


run_clusters <- function(K, distance, minK) {

  clusters <- list()
  
  for(k in minK:K) {
    clusters <- append(clusters, list(genClusters(distance = distance, k = k)))
  }

  return(clusters)
}

genClusters <- function(distance, k, iterations = 10) {
  clusters <- list()
  withinss <- NULL
  # seeds <- NULL
  
  for(i in 1:iterations){
    seed <- round(runif(1, 0, 1) * 10^6,0)
    set.seed(seed)
    
    clust <- kmeans(x = distance, centers = k)
    clust <- append(clust, list(seed = seed))
    withinss <- c(withinss, clust$tot.withinss)
    clusters <- append(clusters, list(clust))
  }
  
  return(clusters[[which(withinss == min(withinss))[1]]])
  
}

get_CH <- function(K, distance, clusters, minK) {
  ch <- list()
  knumber <- minK:K
  
  for(i in 1:length(knumber)) {
    
    list.c.stats <- cluster.stats(distance, 
                        clusters[[i]]$cluster, 
                        silhouette = F, 
                        G2 = F, 
                        G3 = F, 
                        wgap = F, 
                        sepindex = F, 
                        sepprob = 0.1, 
                        sepwithnoise = F)
    
    
    ch = bind_rows(ch, 
                   list(k = knumber[i], 
                        ch = list.c.stats$ch))
  }
  
  return(ch)
}

```

### Number of Clusters

### Subs-Full


```{r SUBS_FULL, eval = F}
K <- 7
minK <- 4

cluster_vars <- c(covariates[!(covariates %in% c("Urban", "Suburban", "ToRu"))], "urbanicity")
# cluster_vars <- c("n", "dSCH", "ST.ratio", "urbanicity")

distance <- df.sim[, cluster_vars] %>%
  mutate(n = log(n),
         dSCH = log(dSCH),
         ST.ratio = log(ST.ratio)) %>%
  # sample_n(500) %>%
  daisy(metric = "gower")




clust_time <- system.time(
  clusters <- run_clusters(K, distance, minK)
)



ch_time <- system.time(
  chPlot <- get_CH(K, distance, clusters, minK)
)

>
K.names <- paste("K_", formatC(minK:K, width = 2, format = "d", flag = "0"), sep = "")

df.clusters <- 
  bind_cols(lapply(clusters, function(x) data.frame(x$cluster))) %>%
  setNames(K.names)

df.clusters <- 
  df.sim %>%
  select(DSID) %>%
  cbind(df.clusters)

cluster.vratio <- unlist(lapply(clusters, function(x) x$betweenss / x$totss)) %>%
  setNames(paste("K", minK:K, sep = "_"))


# undebug(get_CH)
save(clusters, distance, file =  "Data/Cluster Analysis/cluster analysis data.rdata")
save(chPlot, clust_time, ch_time, K, cluster_vars, minK, df.clusters, cluster.vratio, file =  "Data/Cluster Analysis/Clusters.rdata")
```

```{r SUBS_FULL_CH}
# load("clusters-full.rdata")
load("Data/Cluster Analysis/cluster analysis data.rdata")
load("Data/Cluster Analysis/Clusters.rdata")


chPlot %>%
  ggplot(aes(x = k, y = ch)) +
  geom_point() +
  geom_line() +
  theme_apa() +
  scale_x_discrete(limits = c(minK:K))



```

```{r SUBS_FULL_SSB/SST}

data.frame(k = minK:K, var = cluster.vratio, min80 = sum(cluster.vratio <= .8) + minK - .5) %>%
  ggplot(aes(x = k, y = var)) +
  geom_point() +
  # ggtitle("Between cluster variance by number of strata") +
  labs(y = "Between Cluster Variance",
       x = "Number of Strata (k)") +
  geom_line() +
  geom_vline(aes(xintercept = min80), linetype = "dotted") +
  geom_hline(yintercept = .8, linetype = "dotted") +
  theme_apa() +
  scale_x_discrete(limits = c(minK:K)) +
  scale_y_continuous(breaks = seq(0, 1, .1), limits = c(.3, 1)) +
  theme(text = element_text(size=20))

ggsave(filename ="Figs/AERA Cluster SS.jpg", dpi = 1000, width = 10, height = 7)


```

```{r}


# rbind(cls_f, cls_ov) %>%
df.clusters %>%
  gather(key = k, value = cluster, -DSID) %>%
  mutate(k = parse_number(k)) %>%
  group_by(k, cluster) %>%
  summarise(n = n()) %>%
  group_by(k) %>%
  mutate(sample = (n / sum(n)) * 60) %>%
  ggplot(aes(x = k, y = sample)) +
  geom_point(shape = "-", size = 15, alpha = .5) +
  theme_apa() +
  labs(y = "Allocated Sample Size",
       x = "Number of Strata (K)") +
  scale_x_continuous(breaks = seq(minK, K, 1)) +
  scale_y_continuous(breaks = seq(0, 50, 5),
                     limits = c(0, 35),
                     sec.axis = sec_axis(~./60*9882, name = "Strata Size")) +
  stat_function(fun = function(x) 60/x, geom = "line", linetype = "dashed", size = .5) +
  # facet_grid(subs ~ .) +
  # theme(text = element_text(size=20)) +
  geom_hline(yintercept = 5, linetype = "dotted", size = .5) +
  theme(text = element_text(size=20))

ggsave(filename ="Figs/AERA Cluster Size.jpg", dpi = 1000, width = 10, height = 7)



```