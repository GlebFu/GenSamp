```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = F)
```

```{r load.packages, include = FALSE}
library(papaja)
library(tidyverse)

rm(list = ls())

file_date <- "2019-03-26"

load(paste("data/", file_date, "/base data.rdata", sep = ""))

```

## SUBS


```{r SUBS_Funcs}
library(parallel)
library(fpc)
library(cluster)
library(tidyverse)


run_clusters <- function(K, distance, minK) {

  # # Calculate the number of cores
  # no_cores <- min(K, detectCores() - 7)
  # 
  # # Initiate cluster
  # cl <- makeCluster(no_cores)
  # 
  # clusters <- parLapply(cl, 1:K, function(x, y) kmeans(x = y, centers = x), distance)
  # 
  # stopCluster(cl)
  # 
  # # clusters <- bind_cols(clusters)
  # #
  # # names(classign) <- paste("k", 1:K, sep = "")
  
  clusters <- list()
  
  for(k in minK:K) {
    clusters <- append(clusters, list(genClusters(distance = distance, k = k)))
  }

  return(clusters)
}

genClusters <- function(distance, k, iterations = 10) {
  clusters <- list()
  withins <- NULL
  # seeds <- NULL
  
  for(i in 1:iterations){
    seed <- round(runif(1, 0, 1) * 10^6,0)
    set.seed(seed)
    
    clust <- kmeans(x = distance, centers = k)
    clust <- append(clust, list(seed = seed))
    withins <- c(withins, clust$tot.withinss)
    clusters <- append(clusters, list(clust))
  }
  
  return(clusters[[which(withins == min(withins))[1]]])
  
}

get_CH <- function(K, distance, clusters, minK) {
  ch <- list()
  knumber <- minK:K
  
  for(k in 2:length(knumber)) {
    ch1 <- (clusters[[k]]$betweenss / (k - 1)) / (clusters[[k]]$tot.withinss / (length(clusters[[k]]$cluster - k)))
    ch2 <- cluster.stats(distance, clusters[[k]]$cluster,
                                silhouette = F, G2 = FALSE, G3 = FALSE,
                                wgap=F, sepindex=F, sepprob=0.1,
                                sepwithnoise=F)
    ch_d <- ch2$ch
    
    ch = append(ch , list(k = knumber[k], 
                     ch = ch1,
                     ch_d = ch_d))
  }
  
  chPlot <- unlist(ch) %>%
  matrix(3, (K-1)) %>%
  t() %>%
  as.data.frame %>%
  mutate(dif = abs(V2 - V3))
  
  names(chPlot) <- c("k", "ch1", "ch2", "dif")

  
  return(chPlot)
}

```

### Number of Clusters

### Subs-Full


```{r SUBS_FULL, eval = F}
 K <- 10
minK <- 2

cluster_vars <- c(covariates[!(covariates %in% c("Urban", "Suburban", "ToRu"))], "urbanicity")

distance <- df[, cluster_vars] %>%
  mutate(n = log(n)) %>%
  # sample_n(500) %>%
  daisy(metric = "gower")




clust_time <- system.time(
  clusters <- run_clusters(K, distance, minK)
)

ch_time <- system.time(
  chPlot <- get_CH(K, distance, clusters, minK)
)

# undebug(get_CH)
save(clusters, distance, file =  paste("Paper Data/", file_date, "/cluster analysis data.rdata", sep = ""))
save(chPlot, clust_time, ch_time, K, cluster_vars, minK, file =  paste("Paper Data/", file_date, "/Clusters.rdata", sep = ""))
```

```{r SUBS_FULL_CH}
# load("clusters-full.rdata")
load(paste("Paper Data/", file_date, "/Clusters.rdata", sep = ""))


chPlot %>%
  gather(key = method, value = value, ch1:dif) %>%
  ggplot(aes(x = k, y = value, color = method)) +
  geom_point() +
  geom_line() +
  theme_apa() +
  scale_x_discrete(limits = c(1:K))



```

```{r SUBS_FULL_SSB/SST}
cls <- bind_cols(lapply(clusters, function(x) data.frame(x$cluster)))
vrat <- unlist(lapply(clusters, function(x) x$betweenss / x$totss))

data.frame(k = minK:K, var = vrat, min80 = sum(vrat < .8) + .5) %>%
  ggplot(aes(x = k, y = var)) +
  geom_point() +
  ggtitle("Between cluster variance by number of strata") +
  labs(y = "Between Cluster Variance",
       x = "Number of Strata (k)") +
  geom_line() +
  geom_vline(aes(xintercept = min80), linetype = "dashed") +
  theme_apa() +
  scale_x_discrete(limits = c(minK:K)) +
  scale_y_continuous(breaks = seq(0, 1, .1))

names(cls) <- paste("cls_",minK:K, sep = "")

save(chPlot, clust_time, ch_time, K, cluster_vars, cls, minK, file =  paste("Paper Data/", file_date, "/Clusters.rdata", sep = ""))

```

```{r}

# names(cls_ov) <- names(cls_f) <- 1:K
names(cls) <- minK:K
# cls_ov$subs <- "OV"
cls$subs <- "F"


# rbind(cls_f, cls_ov) %>%
cls %>%
  gather(key = k, value = cluster, -subs) %>%
  filter(k > 1) %>%
  mutate(k = as.numeric(k)) %>%
  group_by(k, cluster, subs) %>%
  summarise(n = n()) %>%
  group_by(k, subs) %>%
  mutate(sample = (n / sum(n)) * 60) %>%
  ggplot(aes(x = k, y = sample)) +
  geom_point() +
  theme_apa() +
  labs(y = "Allocated Sample Size",
       x = "Number of Strata (k)") +
  scale_x_discrete(limits = c(1:K)) +
  scale_y_continuous(breaks = seq(0, 30, 5)) +
  stat_function(fun = function(x) 60/x, geom = "line", linetype = "dashed") +
  # facet_grid(subs ~ .) +
  geom_hline(yintercept = 5, linetype = "dotted")
```