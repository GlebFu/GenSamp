---
title             : "GenSamp: RESULTS"
shorttitle        : "RESULTS"

author:
  - name          : "Gleb Furman"
    affiliation   : "1"
    # corresponding : yes    # Define only one corresponding author
    # address       : "Postal address"
    # email         : "Gleb.Furman@gmail.com"
  - name          : "James E. Pustejovsky"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "University of Texas at Austin"
#   - id            : "2"
#     institution   : "Konstanz Business School"

# author_note: |
#   Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

#   Enter author note here.

abstract: |
    <!-- In order for educational research to be informative to policy makers, studies must be designed to make robust estimates of causal effects at the population level. Large scale multi-site randomized trials (MRT) often rely on vague convenience sampling methodology when recruiting districts and schools, resulting in relatively homogeneous samples that may differ greatly from the intended population of interest. Retrospective methods that quantify and statistically adjust for those differences are promising but have limited effect when the sample differs greatly from the population. Designing sampling methods that focus on generalizability may be a more effective but costly solution, but limited methodological research has been performed to examine their effectiveness in the educational context. This paper examines one promising method, stratified balanced sampling (SBS), in the context of recruiting a representative sample of schools for a large scale MRT. Using simulations based on real data, we compare SBS to stratified and unstratified versions of convenience sampling and probability sampling. Several models for generating school participation and emulating convenience sampling are proposed. Results indicate that SBS and stratified random sampling (SRS) result in highly generalizable samples. These methods are extremely costly to implement, however, especially when the population average willingness to participate is low. Stratified convenience sampling (SCS) is a potential compromise. -->

# keywords          : "keywords"
# wordcount         : "X"

bibliography      : ["references.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no
mask              : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_pdf
---


```{r setup, include = FALSE}
rm(list = ls())

output.screen <- T

knitr::opts_chunk$set(echo = F,
                      cache = F,
                      message = output.screen,
                      warning = output.screen,
                      results = "asis",
                      knitr.table.format = "latex")
options(knitr.kable.NA = "-")

```

# Setup

## Packages and Data

```{r load.packages, include = FALSE}
library(papaja)
library(tidyverse)
library(kableExtra)
library(ggalt)
library(ggrepel)
library(ggforce)
library(concaveman)
library(cowplot)

rm(list = ls())


load("Data/Simulation Data/Sim Data.Rdata")
load("Data/Cluster Analysis/Clusters k2-10.rdata")

# load(read_file("Data/Results/LastResults.txt"))
load("Data/Results/1002 Reps - K5 - pam.rdata")

source("0 - Functions - Analysis and Paper.R")

```


## Organize Objects

```{r declare-objects}

df.list <- list()
results <- list()
vars <- list()

tabs <- list()
figs <- list()

df.list$k.stats <- cluster.stats

results$B <- df.B.indicies %>% rename_conditions()
results$r.stats <- df.recruitment.stats %>% rename_conditions()
results$r.counts <- df.samp.counts %>% rename_conditions()
results$s.stats <- df.samp.stats %>% rename_conditions()
results$k <- df.clusters

df.list$strata.id <- df.clusters %>% 
  transmute(DSID = DSID, 
            k = K_05, 
            strata = factor(paste("Strata", k)))

df.list$pop.data <- left_join(df.sim, df.list$strata.id)

df.list$pop.stats <- df.pop.stats

df.list$PS <- df.PS

df.list$cluster.vars <- read_csv("Data/Paper/Clustering Variables.csv")

df.list$coefs <- data.frame(vnames = names(DGM.Bs), 
                            log_odds = DGM.Bs, 
                            row.names = NULL) %>%
  full_join(read_csv("Data/Paper/Clustering Variables.csv"))

rm(list = c("cluster.stats", 
            "df.B.indicies", 
            "df.recruitment.stats", 
            "df.samp.counts", 
            "df.samp.stats", 
            "df.clusters", 
            "df.pop.stats", 
            "df.PS"))

vars$cluster <- list(mixed = cluster_vars, dummy = covariates)

lab.vars <- list(k = "Number of strata (k)", 
                 vratio = expression(paste("Variance Ratio (",
                                           sigma[B]^2/sigma[T]^2,
                                           ")")), 
                 ch = expression("CH index (" ~ 10^3 ~ ")"),
                 n_j = "Target sample per cluster",
                 pop.prop = "Proportion of population (%)",
                 smd = "Standardized mean difference",
                 vars = "Participation covariates",
                 intercept = "Participation model intercept",
                 rr = "Population participation \n(generated %)",
                 B = "Average B-index",
                 coef = "Participation model coeficients \n(absolute log-odds)",
                 contacts = expression("Schools contacted (" ~ 10^2 ~ ")"),
                 rr.o = "Population participation  \n(observed %)")
```

# Data Summary

## Covaraite Statistics
```{r}
tabs$pop.desc <- df.list$pop.data %>%
  select(all_of(vars$cluster$dummy)) %>%
  gather(key = vnames, value = val) %>%
  group_by(vnames) %>%
  summarise(M = mean(val), 
            SD = sd(val)) %>%
  left_join(df.list$coefs) %>%
  left_join(df.list$cluster.vars) %>%
  arrange(Category, Sub) %>%
  select(Category, Variables, M, SD, log_odds)

```

## Continuous variable distributions
```{r}



tabs$dist <- df.list$pop.data %>%
  select(all_of(vars$cluster$mixed)) %>%
  select_if(is.numeric) %>%
  mutate(n = log(n),
         ST.ratio = log(ST.ratio),
         dSCH = log(dSCH)) %>%
  gather(key = vnames, value = val) %>%
  left_join(df.list$coefs)

figs$dist <- tabs$dist %>%
  ggplot(aes(x = val)) +
  geom_histogram() +
  scale_y_continuous(labels = function(x) x / 100) +
  facet_wrap(~ Variables, scales = "free", ncol = 3) +
  labs(x = "", y = "Schools (10^2)")

figs$dist

```


# Methods Summary

## Cluster Analysis

### Selecting k
```{r}
hlines <- df.list$k.stats %>%
  filter(K %in% c(2, 4)) %>%
  select(ch) %>%
  unlist

figs$ch <- df.list$k.stats %>%
  ggplot(aes(x = K, y = ch)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = hlines, linetype = "dotted") +
  scale_x_continuous(breaks = c(2:10)) +
  scale_y_continuous(breaks = seq(5000, 8500, 1000),
                     limits = c(5000, 8500),
                     labels = function(x) x / 1000) +
  labs(y = lab.vars$ch,
       x = lab.vars$k)

figs$ch
```

```{r}



figs$vratio <- df.list$k.stats %>%
  bind_rows(summarise(., K = 1, bt.ss = 0)) %>%
  mutate(min80 = sum(bt.ss <= .8) + min(K) - .5) %>%
  ggplot(aes(x = K, y = bt.ss)) +
  geom_point() +
  geom_vline(aes(xintercept = min80), linetype = "dotted") +
  geom_hline(yintercept = .8, linetype = "dotted") +
  scale_x_continuous(breaks = 1:10) +
  scale_y_continuous(breaks = seq(0, 1, .25), limits = c(0, 1)) +
  geom_line() +
  labs(y = lab.vars$vratio,
       x = lab.vars$k)

figs$vratio
```

```{r}




tabs$allocation <- results$k %>%
  gather(key = k, value = strata, -DSID) %>%
  mutate(k = parse_number(k),
         strata = paste("Strata", strata)) %>%
  group_by(k, strata) %>%
  summarise(n = n()) %>%
  group_by(k) %>%
  mutate(sample = (n / sum(n)) * 60)

figs$allocation <- tabs$allocation %>%
  ggplot(aes(x = k, y = sample)) +
  geom_point(shape = "-", size = 15, alpha = .5) +
  labs(y = lab.vars$n_j,
       x = lab.vars$k) +
  scale_x_continuous(breaks = seq(minK, K, 1)) +
  scale_y_continuous(breaks = seq(0, 50, 5),
                     limits = c(0, 35),
                     sec.axis = sec_axis(~./.6, 
                                         name = lab.vars$pop.prop,
                                         breaks = seq(0, 100, 10))) +
  stat_function(fun = function(x) 60/x, geom = "line", linetype = "dashed", size = .5) +
  geom_hline(yintercept = 5, linetype = "dotted", size = .5)

figs$allocation

```

```{r}

figs$joint.cluster.stats <- 
  plot_grid(plotlist = list(figs$ch,
                            figs$vratio), 
          labels=c("(a)", "(b)"), 
          ncol = 2, 
          nrow = 1, 
          rel_heights = c(1, 1),
          label_x = .5,
          align = "v",
          label_fontface = "plain" ,
          label_size = 10) %>%
  plot_grid(figs$allocation, 
            ncol = 1,
            nrow = 2, 
            labels = c("", "(c)"),
            label_x = .5,
            # align = "h",
            label_fontface = "plain" ,
            label_size = 10)

figs$joint.cluster.stats 
```

```{r, results = "asis"}

tabs$cluster.SMD <- df.list$pop.data %>% 
  # droplevels() %>% 
  select(strata, all_of(covariates)) %>%
  gather(key = var, value = val, -strata) %>%
  group_by(strata, var) %>%
  summarise(strat.mean = mean(val)) %>%
  left_join(df.list$pop.stats) %>%
  transmute(vnames = var,
            SMD = round((pop.mean - strat.mean) / pop.sd, 2)) %>%
  left_join(df.list$coefs)

```


```{r}


figs$cluster.SMD <- tabs$cluster.SMD %>%
  mutate(sig = ifelse(abs(SMD) > .25, "Sig", "Not Sig"),
         neg = SMD > 0,
         k = parse_number(as.character(strata))) %>%
  ggplot(aes(x = SMD, y = Variables, color = strata, alpha = sig, label = k)) +
  geom_text() +
  geom_text(aes(x = 0, y = Variables, label = Variables), color = "black", alpha = 1) +
  geom_vline(xintercept = c(-.25, .25), linetype = "dotted") +
  scale_alpha_discrete(guide = "none")  +
  scale_x_continuous(limits = c(-2,2)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(x = lab.vars$smd ,
       y = lab.vars$vars)

figs$cluster.SMD
```


```{r}

df.list$pop.data %>% 
  select(strata, covariates) %>%
  # select(strata, n, dSCH, ST.ratio) %>%
  mutate(n = log(n),
         dSCH = log(dSCH),
         ST.ratio = log(ST.ratio)) %>%
  gather(key = var, value = val, -strata) %>%
  ggplot(aes(x = strata, y = val)) + 
  geom_boxplot() + 
  facet_wrap(~ var, scales = "free_y") + 
  theme(legend.position = "none")

```

## Participation Generating Model

```{r}


df.list$coefs %>% 
  select(-vnames) %>%
  kable() %>%
  kable_styling()


```


```{r}


tabs$intercepts <- tibble(Intercept = intercepts, RR = names(intercepts), row.names = NULL) %>%
  mutate(RR = parse_number(RR))

tabs$intercepts %>%
  ggplot(aes(x = RR, y = Intercept, group = 1)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  labs(y = lab.vars$intercept,
       x = lab.vars$rr)
```


```{r, fig.cap = "Distributions of Participation Propensity Scores"}
df.list$PS %>% 
  ggplot(aes(x = PS)) + 
  geom_histogram() + 
  facet_wrap(~RR, scales = "free") +
  theme_apa()



left_join(df.list$PS, df.list$strata.id) %>%
  ggplot(aes(x = PS, color = strata, group = strata)) +
  geom_density() +
  facet_wrap(~RR, scales = "free_y")

left_join(df.list$PS, df.list$strata.id) %>%
  ggplot(aes(x = strata, y = PS, color = strata)) +
  geom_boxplot() +
  facet_wrap(~RR, scales = "free_y") + 
  theme(legend.position = "none")

```


# Results

## Generalizability

### B Index

```{r, fig.cap = "Averge B-Index"}


tabs$B <- results$B %>% 
  group_by(sample_method, RR, Clustering, Sampling) %>%
  summarise(M = mean(Bs, na.rm = T),
            SD = sd(Bs, na.rm = T)) %>%
  mutate(LL = M - SD,
         UL = M + SD,
         RR = parse_number(RR),
         Label = paste(str_sub(Clustering, end = 1), Sampling, sep = ""))

tabs$B.label <- tabs$B %>%
  filter(RR == 10) %>%
  mutate(RR = 5)

figs$B <- tabs$B %>%
  ggplot(aes(x = RR, y = M, color = Label, 
             linetype = Label, group = Label)) +
  geom_line() +
  # geom_label(data = tabs$B.label, aes(label = Label)) +
  geom_label_repel(data = tabs$B.label, 
                   aes(label = Label), 
                   direction = "y",
                   point.padding = .1,
                   force = .2,
                   ylim = c(.5, .95)) +
  labs(y = lab.vars$B ,
       x = lab.vars$rr) +
  geom_hline(yintercept = .95, linetype = "dotted") +
  geom_hline(yintercept = .8, linetype = "dashed") +
  scale_x_continuous(breaks = seq(0, 100, 10)) + 
  scale_y_continuous(limits = c(0.5, 1.0), expand = c(0,0)) +
  scale_color_brewer(type = "qual", palette = 6)


figs$B


```



### Standardized mean differences

```{r, fig.cap = "Average SMDs", fig.height = 7}



vars$plot.groups <- bind_rows(
  tibble(group = "Group 1", 
         desc = "good", 
         vnames = c("ethHisp", "pELL", "Urban", "ethWhite", 
                    "ToRu", "pTotfrl", "T1",  "Suburban")),
  tibble(group = "Group 3", 
         desc = "bad", 
         vnames = c("ethBlack", "n", "dSCH")),
  tibble(group = "Group 2", 
         desc = "neutral", 
         vnames = c("pFem", "ST.ratio"))
  )


df.list$smd.results <- results$s.stats %>%
  left_join(df.list$pop.stats) %>%
  mutate(smd = (samp.mean - pop.mean) / pop.sd,
         RR = parse_number(RR),
         Label = paste(str_sub(Clustering, end = 1), Sampling, sep = "")) %>%
  group_by(sample_method, RR, var, Sampling, Clustering, Label) %>%
  summarise(mSMD = mean(smd),
            mSMD.sd = sd(smd),
            mASMD = mean(abs(smd)),
            mASMD.sd = sd(abs(smd))) %>%
  rename(vnames = var) %>%
  left_join(df.list$coefs) %>%
  ungroup()

SMDFigs <- df.list$smd.results  %>%
  left_join(vars$plot.groups ) %>%
  group_by(group, desc) %>%
  nest %>%
  mutate(plots = map(data, plot_smd),
         plots = set_names(plots, paste("smd.", desc, sep = "")),
         data = set_names(data, paste("smd.", desc, sep = ""))) %>%
  ungroup() %>%
  select(data, plots)

tabs[names(SMDFigs$data)] <- SMDFigs$data
figs[names(SMDFigs$plots)] <- SMDFigs$plots


tabs$smd.examples <- 
  df.list$smd.results %>% 
  filter(vnames %in% c("pELL", "pFem", "n")) %>% 
  mutate(Variables = factor(vnames, 
                            labels = c("Group 3", "Group 1", "Group 2")),
         Variables = ordered(Variables, levels =  c("Group 1", "Group 2", "Group 3"))) %>%
  arrange(Variables) 

figs$smd.examples <- 
  tabs$smd.examples %>%
  plot_smd() + 
  facet_wrap(~ Variables, ncol = 2)

figs$smd.examples


```


```{r}

smd.examples.sep <- tabs$smd.examples %>%
  nest(data = -Variables) %>%
  mutate(plots = map(data, plot_smd2),
         plots = map(plots, function(x) x + coord_cartesian(ylim = c(0, 1.1))),
         plots = set_names(plots, paste("smd.", str_replace(Variables, " ", ""), sep = "")),
         data = set_names(data, paste("smd.", str_replace(Variables, " ", ""), sep = ""))) 

tabs$smd.label <- tibble(Label = c("SBS", "SRS", "SCS", "URS", "UCS"),
                       mASMD = (1:5) * .18, 
                       Variables = "Label",
                       xmin = 10, 
                       xmax = 90) %>%
  gather(key = lim, value = RR, xmin, xmax) 

figs$smd.label <- tabs$smd.label %>%
  ggplot(aes(x = RR, y = mASMD, color = Label, linetype = Label, group = Label, label = Label)) +
  geom_line(size = 1) +
  geom_label(data = filter(tabs$smd.label, RR == 10) %>% mutate(RR = 50)) +
  labs(y = lab.vars$smd,
       x = lab.vars$rr) + 
  coord_cartesian(ylim = c(0, 1.1)) +
  scale_x_continuous(breaks = seq(10, 90, 20)) +
  theme(legend.position = "none")  +
  scale_color_brewer(type = "qual", palette = 6) 
    
tabs[names(smd.examples.sep$data)] <- smd.examples.sep$data
figs[names(smd.examples.sep$plots)] <- smd.examples.sep$plots

figs$smd.Group1
figs$smd.label
```

```{r}


# smd.fig.list <- list(plot_grid(plotlist = smd.examples.sep$plots[1:2], 
#                                labels = c("Group 1", "Group 2"), 
#                                ncol = 2, 
#                                nrow = 1, 
#                                rel_heights = c(1, 1),
#                                label_x = .5,
#                                align = "h",
#                                label_fontface = "plain" ,
#                                label_size = 10), 
#                      plot_grid(plotlist = list(smd.examples.sep$plots[[3]], smd.label.plot),
#                                labels = c("Group 3", "Legend"), 
#                                ncol = 2, 
#                                nrow = 1, 
#                                rel_heights = c(1, 1),
#                                label_x = .5,
#                                align = "h",
#                                label_fontface = "plain" ,
#                                label_size = 10)
# 
# )
# 
# plot_grid(plotlist = smd.fig.list,
#                     ncol = 1, 
#                     nrow = 2, 
#                     rel_heights = c(1, 1),
#                     label_x = .5,
#                     align = "h",
#                     label_fontface = "plain" ,
#                     label_size = 10)



```


```{r}

figs$smd.good

```



```{r}
figs$smd.neutral

```
### Examples for presentations

```{r, fig.cap = "Average SMDs", fig.height = 7}


# vars$plot.smd.examples <- bind_rows(
#   tibble(group = "Example", 
#          desc = "each", 
#          vnames = c("pELL", "n", "pFem")),
#   tibble(group = "ELL", 
#          desc = "ell", 
#          vnames = c("pELL")),
#   tibble(group = "N", 
#          desc = "n", 
#          vnames = c("n")),
#   tibble(group = "Fem", 
#          desc = "fem", 
#          vnames = c("pFem"))
#   )
# 
# SMDFigs <-  results$s.stats %>%
#   left_join(df.list$pop.stats) %>%
#   mutate(smd = (samp.mean - pop.mean) / pop.sd,
#          RR = parse_number(RR)) %>%
#   group_by(sample_method, RR, var, Sampling, Clustering, K) %>%
#   summarise(mSMD = mean(abs(smd)),
#             mSMD.sd = sd(abs(smd))) %>%
#   rename(vnames = var) %>%
#   left_join(df.list$coefs) %>%
#   ungroup() %>%
#   left_join(vars$plot.smd.examples ) %>%
#   group_by(group, desc) %>%
#   nest %>%
#   mutate(plots = map(data, plot_smd2),
#          plots = set_names(plots, paste("smd.", desc, sep = "")),
#          data = set_names(data, paste("smd.", desc, sep = ""))) %>%
#   ungroup() %>%
#   select(data, plots)
# 
# tabs <- c(tabs, SMDFigs$data)
# figs <- c(figs, SMDFigs$plots)
# 
# figs$smd.ell
```

### V-ratio and Log odds


```{r}

tabs$v.coef <- df.list$pop.data %>%
  select(DSID, all_of(covariates), strata) %>%
  gather(key = vnames, value = value, covariates) %>%
  group_by(vnames) %>%
  mutate(T.SS = var(value) * (n() - 1)) %>%
  group_by(vnames, T.SS, strata) %>%
  summarise(W.SS = var(value) * (n() - 1)) %>%
  summarise(W.SS = sum(W.SS)) %>%
  mutate(B.SS = T.SS - W.SS,
         vratio = B.SS / T.SS) %>%
  left_join(df.list$coefs) %>%
  left_join(vars$plot.groups) %>%
  mutate(abs_log_odds = abs(log_odds),
         odds = exp(log_odds),
         prob = odds / (1 + odds))%>%
  arrange(group)

figs$v.coef <- tabs$v.coef  %>%
  ggplot(aes(x = vratio, y = abs_log_odds, color = group, fill = group)) + 
  geom_mark_rect(expand = 0.04, color = "black") +
  geom_point(size = 2) +
  # geom_encircle(alpha = .2, s_shape = 0, expand = .1, spread = .05, color = "black") +
  geom_text_repel(aes(label = Variables), point.padding = .2, color = "black") +
  labs(y = lab.vars$coef,
       x = lab.vars$vratio) +
  scale_x_continuous(breaks = seq(0, 1, .1)) +
  scale_y_continuous(breaks = seq(0, .6, .1),
  limits = c(0, .6)) + 
  theme(legend.position =)

figs$v.coef
```



### Test




```{r}

df.test <- df.list$smd.results %>%
  left_join(tabs$v.coef %>% 
              select(vnames, vratio, log_odds, abs_log_odds:prob))

```


```{r}
df.test %>%
  ggplot(aes(x = abs_log_odds, y = mASMD, color = Clustering)) +
  geom_point() +
  geom_hline(yintercept = .25, linetype = "dotted") +
  geom_hline(yintercept = 0) +
  geom_smooth(method = "lm", se = F) +
  facet_grid(Sampling~RR)

df.test %>%
  ggplot(aes(x = log_odds, y = mSMD, color = Clustering)) +
  geom_point() +
  geom_hline(yintercept = .25, linetype = "dotted") +
  geom_hline(yintercept = 0) +
  geom_smooth(method = "lm", se = F) +
  facet_grid(Sampling~RR)

```

```{r}
df.test %>%
  ggplot(aes(x = Sampling, y = mASMD, color = Clustering)) +
  geom_boxplot(alpha = .5,
               position = "dodge2") +
  facet_grid(~ RR) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = .25, linetype = "dotted")

```


```{r}

df.plot <- df.test %>%
  nest(data = everything())  %>%
  mutate(m1 = map(data, lm, formula = mSMD ~ RR),
         m2 = map(data, lm, formula = mSMD ~ log_odds + vratio + RR),
         m3 = map(data, lm, formula = mSMD ~ log_odds * vratio * RR)) %>%
  gather(model, fit, -data) %>%
  mutate(res = map(fit, function(x) x$residuals),
         plot.data = map2(data, 
                          res, 
                          function(x, y) x %>% mutate(res = y)))



anova(df.plot$fit[[1]], df.plot$fit[[2]], df.plot$fit[[3]])

texreg::screenreg(df.plot$fit)

df.plot %>%
  select(model, plot.data) %>%
  unnest(plot.data) %>%
  ggplot(aes(x = RR, y = res, color = Sampling, linetype = Clustering)) +
  # geom_point(alpha = .5) +
  geom_smooth() +
  facet_wrap(~model)

df.plot %>%
  select(model, plot.data) %>%
  unnest(plot.data) %>%
  ggplot(aes(x = RR, y = res, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() + 
  geom_hline(yintercept = 0) + 
  geom_hline(yintercept = .25, linetype = "dotted") +
  facet_grid(vnames ~ model, scale = "free_y")
  
```


```{r}

df.plot %>%
  select(model, plot.data) %>%
  unnest(plot.data) %>%
  ggplot(aes(x = vratio, y = res, color = Clustering)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_grid(model ~ RR)

```
### Test 2

```{r}
df.test.2 <- results$s.stats %>%
  ungroup() %>%
  left_join(df.list$pop.stats) %>%
  mutate(smd = (samp.mean - pop.mean) / pop.sd,
         a_smd = abs(smd),
         RR = parse_number(RR))

df.test.2.sum <- df.test.2 %>%
  ungroup() %>%
  group_by(sample_method, RR, var, Sampling, Clustering) %>%
  summarise(mSMD = mean(smd),
            mSMD.sd = sd(smd),
            mASMD = mean(a_smd),
            mASMD.sd = sd(a_smd))

df.test.2.sum %>%
  ggplot(aes(x = mSMD, y = mSMD, color = sample_method)) +
  geom_point() +
  geom_vline(xintercept = 0)+
  facet_wrap(~RR)

df.test.2 %>%
  filter(var == "ethWhite") %>%
  ggplot(aes(x = RR, y = a_smd, color = sample_method)) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3))

df.test.2 %>%
  filter(var == "ethWhite") %>%
  ggplot(aes(x = RR, y = smd, color = sample_method)) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3))
```

## Feasibility

### Sampling Difficulty

```{r}
tabs$samples <- results$r.stats %>%
  group_by(sample_method, RR, measure, Sampling, Clustering, K) %>%
  summarise(value = mean(value)) %>%
  mutate(RR = parse_number(RR))


```


```{r, fig.cap = "Recruitment Counts"}
# figs$samples <- tabs$samples  %>%
#   ggplot(aes(x = RR, y = value, group = sample_method, color = Sampling, linetype = Clustering)) +
#   geom_point() +
#   geom_line() +
#   facet_wrap( ~ measure, scales = "free_y") +
#   expand_limits(y = 0) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# 
# figs$samples


```





```{r, fig.cap = "Schools Contacted"}


figs$samples.contacts <- tabs$samples %>%
  filter(measure == "sch.contacted") %>%
  ggplot(aes(x = RR, y = value, group = sample_method, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  scale_y_continuous(breaks = seq(0, 4000, 500),
                     limits = c(0, 4000),
                     labels = function(x) x / 100) +
  labs(x = lab.vars$rr,
       y = lab.vars$contacts)

figs$samples.contacts


```

```{r, fig.cap = "Sampling response rates"}


figs$samples.response.rates <- tabs$samples %>%
  filter(measure == "sch.response.rate") %>%
  mutate(value = value * 100) %>%
  ggplot(aes(x = RR, y = value, group = sample_method, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  expand_limits(y = 0) +
  theme(legend.position = "none") +
  labs(x = lab.vars$rr,
       y = lab.vars$rr.o) +
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  scale_y_continuous(breaks = seq(0, 100, 10)) 

figs$samples.response.rates
```




```{r}

legend <- get_legend(
  figs$samples.contacts +
  theme_apa(box = F) + 
  theme(legend.box.margin = margin(0, 0, 0, 12))
)

figs$joint.feasibility <- plot_grid(plotlist = list(figs$samples.contacts + theme(legend.position = "none"),
                                                    figs$samples.response.rates + theme(legend.position = "none")),
                                    labels=c("(a)", "(b)"),
                                    ncol = 1, 
                                    nrow = 2, 
                                    label_x = .5,
                                    align = "v",
                                    label_fontface = "plain",
                                    label_size = 10) %>%
  plot_grid(legend, rel_widths = c(3, .4))

figs$joint.feasibility

```

### Relative Performance

```{r}
tabs$relative.counts <- tabs$samples  %>%
  ungroup() %>%
  filter(measure %in% c("sch.contacted")) %>%
  select(-Sampling, -Clustering) %>%
  spread(key = sample_method, value = value) %>%
  right_join(tabs$samples  %>% filter(measure == "sch.contacted")) %>%
  gather(key = Comp.Method, value = Comp.Value,
         Stratified_BS:Unstratified_RS) %>%
  mutate(Comp.Times = value / Comp.Value) 

figs$relative.counts <- tabs$relative.counts %>%
  ggplot(aes(x = RR, y = Comp.Times, group = sample_method, color = Sampling, linetype = Clustering)) +
  geom_line() +
  facet_wrap(~ Comp.Method, scales = "free") 

```

### Gini Plot
```{r}
tabs$gini.count <- results$r.counts %>%
  group_by(sample_method, Clustering, Sampling, DSID, RR) %>%
  count(name = "count") %>%
  group_by(sample_method, Clustering, Sampling, RR) %>%
  nest() %>%
  mutate(data = map(data, full_join, df.list$pop.data %>% select(DSID))) %>%
  unnest %>%
  group_by(sample_method, Clustering, Sampling, RR) %>%
  mutate(count = ifelse(is.na(count), 0, count),
         prop.selected = count/sum(count),
         n = n(),
         prop.pop = 1/n()) %>%
  group_by(sample_method, Clustering, Sampling, RR) %>%
  arrange(prop.selected) %>%
  mutate(c.prop.sel = cumsum(prop.selected),
         c.prop.pop = cumsum(prop.pop))

tabs$gini.coef <- tabs$gini.count %>%
  summarise(gini = ineq::Gini(prop.selected) %>% round(2)) %>%
  group_by(RR) %>%
  arrange(gini) %>%
  mutate(y.pos = 1 - (1:n()/n()) / 1.5,
         x.pos = 1 - y.pos)


lab.vars$gini <- "Gini Coeficient"


figs$gini <- tabs$gini.coef %>%
  mutate(RR = parse_number(RR)) %>%
  ggplot(aes(x = RR, y = gini, group = sample_method, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(10, 90, 10)) +
  scale_y_continuous(breaks = seq(0, 1, .1),
                     limits = c(0, 1), expand = c(0,0)) +
  labs(x = lab.vars$rr,
      y = lab.vars$gini)

figs$gini.coef <- tabs$gini.count %>%
  # filter(RR == "RR_90") %>%
  # filter(sample_method == "Unstratified_RS") %>%
  ggplot(aes(x = c.prop.pop, y = c.prop.sel, group = sample_method, color = Sampling, linetype = Clustering)) +
  geom_line() +
  geom_abline(slope = 1, intercept = 0, linetype = "dotted") +
  geom_label(aes(label = gini, x = x.pos, y = y.pos), 
             data = tabs$gini.coef, size = 3) +
  facet_wrap(~RR) +  
  # (if (grey.plots) {scale_colour_grey(start = 0, end = .7)}) +
  labs(x = "Cumulative proportion of population",
         y = "Cumulative percentage of times sampled") +
  theme_apa()

ggsave(filename = "Figs/Presentation/GINI.jpg", dpi = 100, width = 10, height = 6)
```


# Export Plots

```{r}
# figs
# 
# # i <- 12
# 
# for(i in 1:length(figs)) {
#   
#   print.fig <- figs[[i]] +
#     scale_color_brewer(type = "qual", palette = 2) +
#     theme_bw() +
#     theme(text = element_text(size = 20)) 
#   
#   f.name <- paste("Figs/Presentation/Fig ", i, " - ", names(figs)[i],".jpg", sep = "")
#   
#   ggsave(plot = print.fig, filename = f.name, dpi = 1000, width = (6*1.6), height = (6))
# }

```

```{r}
# library(cowplot)
# 
# fig.SCS <- list(
#   figs$smd.ell +
#     scale_color_brewer(type = "qual", palette = 2) +
#     theme_bw() +
#     theme(text = element_text(size = 10),
#           legend.position = "none",
#           axis.title.x = element_blank(),
#           axis.ticks = element_blank(),
#           axis.text.x = element_blank()) +
#     labs(y = "SMD"),
#   figs$B +
#     scale_color_brewer(type = "qual", palette = 2) +
#     theme_bw() +
#     theme(text = element_text(size = 10),
#           legend.position = "right",
#           axis.title.x = element_blank(),
#           axis.ticks = element_blank(),
#           axis.text.x = element_blank()) +
#     labs(y = "B-Index"),
#   figs$samples.contacts +
#     scale_color_brewer(type = "qual", palette = 2) +
#     theme_bw() +
#     theme(text = element_text(size = 10),
#           legend.position = "none") +
#     labs(y = "Contacts") +
#     scale_y_continuous(breaks = seq(0, 4000, 1000),
#                        limits = c(0, 4000))
# )
# 
# plot_grid(plotlist = fig.SCS, 
#           ncol = 1, 
#           nrow = 3, 
#           rel_heights = c(1, 1, 1.3),
#           label_x = .5,
#           align = "v",
#           axis = "lr",
#           label_fontface = "plain" ,
#           label_size = 10)

 # ggsave(filename = "Figs/Presentation/Fig Middle.jpg", dpi = 1000, width = (6*1.6), height = (6))
```

```{r}
save(df.list,
     figs,
     lab.vars,
     results,
     tabs,
     vars,
     file = "Data/Paper/Paper Data 09-27-2020.rdata")
```
