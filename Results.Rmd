---
title: "Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = F)
```

```{r load.packages, include = FALSE}
library(papaja)
library(tidyverse)

rm(list = ls())

runtimeFile <- "Data/2018-07-11/runtime r1000.rdata"
resultsFile <- "Data/2018-07-11/results r1000.rdata"

load("data/base data.rdata")

# Base data set
load("Data/simData.Rdata")

# Response generating variables and goal SMD
load("Data/RGM Vars.Rdata")

load(runtimeFile)
load(resultsFile)

savePlot <- F
```

```{r}
boxErrors <- function(x) {
  v <- c(min(x), mean(x) - sd(x), mean(x), mean(x) + sd(x), max(x))
  names(v) <- c("ymin", "lower", "middle", "upper", "ymax")
  v
}

```

Distribution of propensity scores by response rates
```{r}

df.sch %>% 
  select(PS90:PS10) %>% 
  gather(key = RR, value = PS) %>% 
  ggplot(aes(x = PS)) + 
  geom_histogram() + 
  facet_wrap(~RR) +
  theme_apa()


```

## B Index

Conditions where B Index is below .2

```{r}


df_Bindex$sch.RR.f <- ordered(df_Bindex$sch.RR)

# levels(df_Bindex$sch.RR.f) <- paste(c("\n", "School Rate\n", "\n"), levels(df_Bindex$sch.RR.f))

df_Bindex %>% 
  select(sample:Bs) %>% 
  filter(Bs < .2) %>%
  as.tibble() %>%
  group_by(sample, sch.RR) %>%
  summarise(n = n()) %>%
  spread(key = sch.RR, value = n)
```

```{r}
df_Bindex %>%
  ggplot(aes(x = sample, y = Bs, fill = sample)) +
  # stat_summary(fun.data = boxErrors, geom = "boxplot", position = position_dodge(width=1)) +
  geom_boxplot() +
  facet_wrap(~ sch.RR.f) +
  theme_apa(box = T) +
  scale_fill_brewer(type = "seq", palette = 4, guide=FALSE) +
  scale_color_brewer(type = "qual", palette = 5)  +
  theme(legend.position = "none",
        panel.spacing = unit(2, "lines"),
        # text = element_text(size=20),
        # legend.title = element_text(size=15),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Sampling Method", y = "B-Index")
  

```

```{r}
B_plot <- df_Bindex %>%
  group_by(sample, sch.RR) %>%
  summarise(All = mean(Bs),
            Partial = mean(Bs[Bs > .2]),
            All_sd = sd(Bs),
            Partial_sd = sd(Bs[Bs > .2])) %>%
  gather(key = Type, value = Bs, All, Partial, All_sd, Partial_sd) %>%
  mutate(Var = ifelse(str_detect(Type, "sd"), "SD", "M"),
         Type = ifelse(str_detect(Type, "All"), "All", "Partial")) %>%
  spread(key = Var, value = Bs) %>%
  group_by(sample, sch.RR, Type) %>%
  summarise(M = mean(M),
            SD = mean(SD)) %>%
  mutate(Clustering = ifelse(str_detect(sample, "SUBS"), "SUBS", "None"),
         Ranking = str_replace(sample, "SUBS_", ""))

B_plot %>%
  ggplot(aes(x = sch.RR, y = M, color = Ranking, linetype = Clustering)) +
  # stat_summary(fun.data = boxErrors, geom = "boxplot", position = position_dodge(width=1)) +
  geom_line() + 
  # geom_errorbar(aes(ymin=LL, ymax=UL), colour="black", width=.1) +
  facet_wrap(~ Type) +
  theme_apa(box = T) +
  scale_fill_brewer(type = "seq", palette = 3, guide=FALSE) +
  scale_color_brewer(type = "qual", palette = 2)  +
  theme(legend.position = "right",
        panel.spacing = unit(2, "lines"),
        # text = element_text(size=20),
        # legend.title = element_text(size=15),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Sampling Method", y = "B-Index")
  

if(savePlot) ggsave("Figs/B-Index.jpg", dpi = 1000, width = 11, height = 8.5)
if(savePlot) ggsave("Figs/B-Index.jpg", dpi = 1000, width = 10, height = 4)
```


## Standardized mean differences

```{r}
sSMDplot <- df_sch_smd %>%
  group_by(sample, sch.RR, Variable, Group, variable) %>%
  summarise(value = mean(abs(value), na.rm = F)) %>% 
  spread(key = variable, value = value) %>%
  ungroup() %>%
  mutate(sch.RR = factor(sch.RR)) %>%
  mutate(Clustering = ifelse(str_detect(sample, "SUBS"), "SUBS", "None"),
         Ranking = str_replace(sample, "SUBS_", ""))

# levels(sSMDplot$dist.RR) <- paste("District: ", levels(sSMDplot$dist.RR), "%", sep = "")
# levels(sSMDplot$sch.RR) <- paste("School: ", levels(sSMDplot$sch.RR), "%", sep = "")

sSMDplot %>%
  filter(Group == "sampled") %>%
  ggplot(aes(x = sch.RR, y = sim_SMD, group = sample, color = Ranking, linetype = Clustering)) +
  # geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = .25, linetype = "dashed") +
  facet_wrap( ~ Variable, scales = "free_y") +
  theme_apa(box = T)


```


```{r}
sSMDplot %>%
  filter(Group == "sampled") %>%
  ggplot(aes(x = sample, y = sim_SMD, group = sample, fill = Ranking, linetype = Clustering)) +
  geom_boxplot() +
  geom_line() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = .25, linetype = "dashed") +
  # facet_grid(dist.RR ~ sch.RR, scales = "free_y") +
  theme_apa(box = T) +
  scale_fill_brewer(type = "seq", palette = 4, guide=FALSE) +
  scale_color_brewer(type = "qual", palette = 5)  +
  theme(legend.position = "none",
        panel.spacing = unit(2, "lines"),
        text = element_text(size=20),
        legend.title = element_text(size=15)) +
  labs(x = "Sampling Method", y = "Absolute SMD")

if(savePlot)  ggsave("Figs/Sch SMDs.jpg", dpi = 1000, width = 11, height = 8.5)
if(savePlot)  ggsave("Figs/Sch SMDs.jpg", dpi = 1000, width = 10, height = 4)
```

## Sampling Difficulty

```{r}
samplot <- df_responses %>%
  filter(is.na(cluster)) %>%
  group_by(sample, sch.RR, variable) %>% 
  summarise(value = mean(value)) %>%
  spread(key = variable, value = value) %>%
  mutate(Clustering = ifelse(str_detect(sample, "SUBS"), "SUBS", "None"),
         Ranking = str_replace(sample, "SUBS_", ""))

```


```{r}
samplot %>%
  gather(key = measure, value = value, -sample, -sch.RR, -Clustering, -Ranking) %>%
  mutate(level = str_split(measure, "_", simplify = T)[,1],
         measure =  str_split(measure, "_", simplify = T)[,2]) %>%
  filter(level == "sch") %>%
  ggplot(aes(x = sch.RR, y = value, group = sample, color = Ranking, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  facet_wrap( ~ measure, scales = "free_y") +
  expand_limits(y=0) +
  theme_apa(box = T)

```


```{r}
df_responses %>%
  filter(is.na(cluster), str_detect(variable, "sch_contacted")) %>%
  ggplot(aes(x = sample, y = value, fill = sample)) +
  stat_summary(fun.data = boxErrors, geom = "boxplot", position = position_dodge(width=1)) +
  facet_wrap( ~ sch.RR, scales = "free_y") +
  theme_apa(box = T) +
  scale_fill_brewer(type = "seq", palette = 4, guide=FALSE) +
  scale_color_brewer(type = "qual", palette = 5)  +
  theme(legend.position = "none",
        panel.spacing = unit(2, "lines"),
        # text = element_text(size=20),
        # legend.title = element_text(size=15),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Sampling Method", y = "Schools Contacted")

```



