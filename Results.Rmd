---
title             : "GenSamp: RESULTS"
shorttitle        : "RESULTS"

author:
  - name          : "Gleb Furman"
    affiliation   : "1"
    # corresponding : yes    # Define only one corresponding author
    # address       : "Postal address"
    # email         : "Gleb.Furman@gmail.com"
  - name          : "James E. Pustejovsky"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "University of Texas at Austin"
#   - id            : "2"
#     institution   : "Konstanz Business School"

# author_note: |
#   Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

#   Enter author note here.

abstract: |
    <!-- In order for educational research to be informative to policy makers, studies must be designed to make robust estimates of causal effects at the population level. Large scale multi-site randomized trials (MRT) often rely on vague convenience sampling methodology when recruiting districts and schools, resulting in relatively homogeneous samples that may differ greatly from the intended population of interest. Retrospective methods that quantify and statistically adjust for those differences are promising but have limited effect when the sample differs greatly from the population. Designing sampling methods that focus on generalizability may be a more effective but costly solution, but limited methodological research has been performed to examine their effectiveness in the educational context. This paper examines one promising method, stratified balanced sampling (SBS), in the context of recruiting a representative sample of schools for a large scale MRT. Using simulations based on real data, we compare SBS to stratified and unstratified versions of convenience sampling and probability sampling. Several models for generating school participation and emulating convenience sampling are proposed. Results indicate that SBS and stratified random sampling (SRS) result in highly generalizable samples. These methods are extremely costly to implement, however, especially when the population average willingness to participate is low. Stratified convenience sampling (SCS) is a potential compromise. -->

# keywords          : "keywords"
# wordcount         : "X"

bibliography      : ["references.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no
mask              : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_pdf
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = F, warnings = F)
```

```{r load.packages, include = FALSE}
library(papaja)
library(tidyverse)

rm(list = ls())

file_date <- "2019-03-26"


runtimeFile <- paste("Data/", file_date, "/runtime r10.rdata", sep = "")
resultsFile <- paste("Data/", file_date, "/results r10.rdata", sep = "")

load(paste("data/", file_date, "/base data.rdata", sep = ""))

# Base data set
load(paste("Data/", file_date, "/simData.Rdata", sep = ""))

load(runtimeFile)
load(resultsFile)

rename_conditions <- function(orig.data) {
  orig.data %>%
  mutate(sample = str_replace(sample, "F", "BS"),
         sample = str_replace(sample, "CS", "CS"),
         sample = str_replace(sample, "SRS", "RS"),
         Sampling = str_replace(sample, "SUBS_", ""),
         Clustering = ifelse(str_detect(sample, "S_"), "Stratified", "Unstratified"),
         sample = paste("U_", sample, sep = ""),
         sample = str_replace(sample, "U_SUBS_", "S_"))
}

df_Bindex <- df_Bindex %>% rename_conditions()

df_counts <- df_counts %>% rename_conditions()

df_responses <- df_responses %>% rename_conditions()
  
df_sch_stats <- df_sch_stats %>% rename_conditions()

savePlot <- F
```


```{r}
boxErrors <- function(x) {
  v <- c(min(x), mean(x) - sd(x), mean(x), mean(x) + sd(x), max(x))
  names(v) <- c("ymin", "lower", "middle", "upper", "ymax")
  v
}

```



# Methods Summary

## Participation Generating Model

```{r, fig.cap = "Distributions of Participation Propensity Scores"}


df.sch %>% 
  select(contains("PS")) %>% 
  gather(key = RR, value = PS) %>% 
  ggplot(aes(x = PS)) + 
  geom_histogram() + 
  facet_wrap(~RR, scales = "free") +
  theme_apa()


```


```{r, fig.cap = "Difference between expected SMDs and goal SMDs"}
# schVals_lab <- schVals %>%
#   filter(RR == max(RR)) %>%
#   mutate(RR = paste(RR*100, "%", sep = "")) %>%
#   select(Var, dif, RR, pars)
# 
# 
# schVals %>%
#   filter(Var != "Intercept") %>%
#   select(Var, dif, RR) %>%
#   mutate(RR = ordered(paste(RR*100, "%", sep = ""),
#                       levels  = paste(sort(unique(RR))*100, "%", sep = ""))) %>%
#   na.omit() %>%
#   ggplot(aes(x = RR, y = dif, group = Var, linetype = Var, color = Var)) +
#   geom_point() +
#   geom_line() +
#   theme_apa() +
#   labs(x = "Population Response Rates",
#        y = expression(Delta*"SMD")) +
#   ggrepel::geom_text_repel(data = schVals_lab, 
#                            aes(x  = RR, y = dif, label = Var),
#                            direction = "y",
#                            nudge_x = 1,
#                            xlim = c(NA, 10.4),
#                            segment.size = .1,
#                            vjust = 1) +
#   theme(legend.position="none",
#        plot.margin=unit(c(0,2,0,0),"cm")) +
#   coord_cartesian(clip = 'off')
```


```{r, results = "asis", fig.cap="Odds ratio coeficients for Response Generating Model"}


# schVals %>%
#   # filter(Var != "Intercept") %>%
#   select(Var, pars, RR) %>%
#   mutate(RR = ordered(paste(RR*100, "%", sep = ""),
#                       levels  = paste(sort(unique(RR))*100, "%", sep = ""))) %>%
#   ggplot(aes(x = RR, y = pars, group = Var, linetype = Var, color = Var)) +
#   geom_point() +
#   geom_line() +
#   theme_apa() +
#   labs(x = "Population Response Rates",
#        y = expression(beta[h])) +
#   ggrepel::geom_text_repel(data = schVals_lab, 
#                            aes(x  = RR, y = pars, label = Var),
#                            direction = "y",
#                            nudge_x = 1,
#                            xlim = c(NA, 10.4),
#                            segment.size = .1,
#                            vjust = 1) +
#   theme(legend.position="none",
#        plot.margin=unit(c(0,2,0,0),"cm")) +
#   coord_cartesian(clip = 'off')
```

## B Index

```{r, fig.cap = "Averge B-Index"}

avg_Bindex <- df_Bindex %>%
  group_by(sample, sch.RR, Clustering, Sampling) %>%
  summarise(M = mean(Bs),
            SD = sd(Bs)) %>%
  group_by(sample, sch.RR, Clustering, Sampling) %>%
  summarise(M = mean(M),
            SD = mean(SD)) %>%
  mutate(LL = M - SD,
         UL = M + SD)

avg_Bindex %>%
  ggplot(aes(x = sch.RR, y = M, color = Sampling, linetype = Clustering)) +
  geom_line() +
  labs(y = "Mean B-index",
       x = "Population Participation Rate") +
  theme_apa()
  

if(savePlot) ggsave(paste("Figs/", file_date, "/Paper B-Index.jpg", sep = ""), dpi = 1000, width = 7, height = 4)
```



## Standardized mean differences

```{r, fig.cap = "Average SMDs"}
sSMDplot <- df_sch_stats %>%
  group_by(sample, sch.RR, var, sample, Sampling, Clustering) %>%
  summarise(mSMD = mean(abs(smd)),
            mSMD.sd = sd(abs(smd)))

df_sch_stats %>%
  filter(is.na(smd)) %>%
  unique()

sSMDplot %>%
  # ggplot(aes(x = sch.RR, y = mSMD, color = sample, linetype = sample, group = sample)) +
  ggplot(aes(x = sch.RR, y = mSMD, color = Sampling, linetype = Clustering, group = sample)) +
  # geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = .25, linetype = "dashed") +
  facet_wrap( ~ var, scales = "free_y") +
  theme_apa(box = F) +
  labs(y = "Mean SMD",
       x = "Population Participation Rate")

if(savePlot)  ggsave(paste("Figs/", file_date, "/All SMDs.jpg", sep = ""), dpi = 1000, width = 7, height = 5)
```



## Sampling Difficulty

```{r}
samplot <- df_responses %>%
  filter(is.na(cluster)) %>%
  group_by(sample, sch.RR, variable, Sampling, Clustering) %>%
  summarise(value = mean(value)) %>%
  spread(key = variable, value = value)
```


```{r, fig.cap = "Recruitment Counts"}
samplot %>%
  gather(key = measure, value = value, -sample, -sch.RR, -Sampling, -Clustering) %>%
  mutate(level = str_split(measure, "_", simplify = T)[,1],
         measure =  str_split(measure, "_", simplify = T)[,2]) %>%
  filter(level == "sch") %>%
  ggplot(aes(x = sch.RR, y = value, group = sample, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  facet_wrap( ~ measure, scales = "free_y") +
  expand_limits(y=0) +
  theme_apa(box = T)

```





```{r, fig.cap = "Schools Contacted"}
samplot2 <- samplot %>%
  gather(key = measure, value = value, -sample, -sch.RR, -Sampling, -Clustering) %>%
  mutate(level = str_split(measure, "_", simplify = T)[,1],
         measure =  str_split(measure, "_", simplify = T)[,2]) %>%
  filter(measure == "contacted") %>%
  mutate(level = ifelse(level == "sch", "Schools", "Districts"))

samplot2 %>%
  ggplot(aes(x = sch.RR, y = value, group = sample, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  facet_wrap( ~ level, scales = "free_y") +
  expand_limits(y=0) +
  # theme_apa(box = T) +
  # scale_fill_brewer(type = "seq", palette = 4) +
  # scale_color_brewer(type = "qual", palette = 3)  +
  theme(legend.position = "bottom",
        panel.spacing = unit(2, "lines"),
        # text = element_text(size=20),
        # legend.title = element_text(size=15),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Population Response Rate", y = "Units Contacted") +
  theme_apa()

if(savePlot)  ggsave(paste("Figs/", file_date, "/Units Contacted.jpg", sep = ""), dpi = 1000, width = 7, height = 5)

```

```{r, fig.cap = "Sampling response rates"}
df.rr <- df_responses %>%
  filter(str_detect(variable, "sch_RR"), is.na(cluster)) %>%
  group_by(sample, sch.RR, Sampling, Clustering) %>%
  summarise(value = mean(value)) %>%
  rename(RR = sch.RR) %>%
  mutate(Unit = "School")


df.rr %>%
  ggplot(aes(x = RR, y = value, group = sample, color = Sampling, linetype = Clustering)) +
  geom_point() +
  geom_line() +
  facet_grid(~ Unit) +
  expand_limits(y = 0) +
  theme_apa(box = T) +
  # scale_fill_brewer(type = "seq", palette = 4) +
  # scale_color_brewer(type = "qual", palette = 3)  +
  theme(legend.position = "bottom",
        panel.spacing = unit(2, "lines"),
        text = element_text(size=20),
        legend.title = element_text(size=15),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Generating Repsonse Rate", y = "Actual Response Rate") +
  geom_abline(slope = 25, intercept = 1, linetype = "dashed")

```


```{r}
save(avg_Bindex, df_Bindex, df_responses, df_sch_stats, samplot, sSMDplot, file = paste("Paper Data/", file_date, "/Result Data.rdata", sep = ""))

```